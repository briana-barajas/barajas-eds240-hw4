---
title: "HW 2 - Data Wrangling and Exploration"
subtitle: "Data wrangling and exploration for final assignment"
author: "Briana Barajas"
date: 2024-02-01
toc: true
format: html
editor_options: 
  chunk_output_type: console
---

## Preparation

```{r, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

Libraries

```{r}
library(tidyverse)
library(here)
library(janitor)
library(ggridges)
library(readxl)
```

Read Data

```{r}
# capture, mark, remark frog survey data 
frogs_raw <- read_csv(here("data", "frog_cmr", "cmrData.csv")) %>% 
  clean_names()

# data on water/environmental conditions 
water_raw <- read_csv(here("data","frog_cmr", "waterCov.csv")) %>% 
  clean_names()

# data on egg masses
eggs_raw <- read_xlsx(here("data", "egg_mass", "frog-monitoring-observations.xlsx")) %>% clean_names()

```

## Wrangle and Join

Wrangle `water` and `frogs` data, then join
```{r}
## ==========================================
##            wrangle water data         ----
## ==========================================

water <- water_raw %>% 
  
  # filter to Middle Jack reach
  filter(reach == 'Middle Jack') %>% 
  
  # convert year to factor
  mutate(year = as.factor(year))

## ==========================================
##         wrangle frog data         ----
## ==========================================

frogs <- frogs_raw %>%
  
  # filter reach to Middle Jack
  filter(reach == "Middle Jack") %>% 
  
  # make the col header (year_visit) one column, and frog_detected col
  pivot_longer(cols = 5:43,
               names_to = "year_visit",
               values_to = "frog_detected") %>% 
  
  # split year and visit number into two columns %>% 
  separate(year_visit, 
           c("year", "visit"),
           '_') %>% 
  
  # remove x that precedes the year (x2010, x2011, etc)
  mutate(year = str_remove(year, 'x')) %>% 
  
  # change year to date objected
  mutate(year = as.factor(year)) %>% 
  
  # combine annual visits
  group_by(sex, tag, year) %>%
  summarise(frog_detected = sum(frog_detected)) %>% 
  mutate(frog_detected = ifelse(frog_detected != 0, 1, 0))

## ==========================================
##         wrangle egg mass data         ----
## ==========================================
eggs <- eggs_raw %>% 
  
  # rename site_id to reach name
  rename(reach = site_id) %>% 
  
  # filter reach to Middle Jack
  filter(reach == "Middle Jack") %>% 
  
  # select key columns
  select(c(survey_date, count, life_stage)) %>% 
  
  # update survey_date to date-time object
  mutate(survey_date = as.Date(survey_date),
         year = year(survey_date)) %>% 
  
  # count egg masses per year
  group_by(life_stage, year) %>% 
  summarise(count = sum(count))



## ==========================================
##             join all data             ----
## ==========================================
# prep raw data to re-join to frogs to keep length(sul) measurements
frogs_raw <- frogs_raw %>%
  
  select(-starts_with('x')) %>% # remove unwrangled year columns
  rename(sul_mm = sul) # rename sul column


# re-join data
frogs <- left_join(frogs, frogs_raw, by = c('tag','sex'))

# final df join, environmental factors and frog 
frogs_env <- frogs %>% 
  
  full_join(water, by = c('year', 'reach')) # full join frog data to water data by the year column

# remove extra variables from env
rm(frogs_raw, water_raw, eggs_raw)
```

## Calculate Probability
Calculating the probability that an individual from will be seen the next year


```{r, eval=FALSE}
# calculate proportion of individuals that were found every year 
frog_prop <- frogs_env %>% 
  
  # create 3 key size categories
  mutate(sul_mm = as.numeric(sul_mm)) %>% 
  mutate(size_group = case_when(sul_mm <= 54 ~ "small",
                                sul_mm > 54 & sul_mm < 66 ~ "medium",
                                sul_mm >= 66 ~ "large")) %>%
  
  # calculate annual proportion of surveyed/survived based on size
  group_by(year, size_group) %>% 
  summarise(prop_detected = sum(frog_detected)/n())

# plot results
frog_prop %>% 
  ggplot() +
  geom_vline(xintercept = "2014", linetype = 2) +
  geom_bar(aes(x = year, y = prop_detected, fill = size_group),
           position = "stack", stat = "identity") +
  theme_bw() +
  scale_fill_manual(values = c('#a3b18a','#588157','#344e41')) +
  labs(x = "Year",
       y = "Proportion Frogs Detected",
       title = "Proportion of Frogs Found in Capture-mark-release Surveys",
       fill = "Relative Size") +
  annotate("text", x = "2014",y = Inf, 
           label = "ponds excavated to
    mitigate drought", size = 3,
    hjust = -0.1, vjust = 1.7)
```

## END HW 2, START HW3

Plot different life stage surveys over the years
```{r}
eggs %>% 
  ggplot(aes(x = year, y = count, col = life_stage)) +
  geom_line(linewidth = 1.2) +
  geom_point() +
  theme_bw()
```

View how different sexes did over the years
```{r}
# prep count data for dumbbell plot
frog_d <- frogs %>% 
  
  # calculate sum of surveyed frogs based on sex
  group_by(year, sex) %>% 
  summarise(frog_count = sum(frog_detected)) %>% 
  
  # change year to numeric for plot type
  mutate(year = as.numeric(as.character(year))) %>% 
  
  # pivot so start/end points are in different columns
  pivot_wider(names_from = sex, values_from = frog_count)

# dumbell plot sex
ggplot(frog_d) +
  geom_segment(aes(x = female, xend = male,
                   y = year, yend = year), linewidth = 0.7) +
  geom_point(aes(x = female, y = year), col = "#F35C4A", size = 4) +
  geom_point(aes(x = male, y = year), col = "#A3B18A", size = 4) +
  theme_classic()

```


```{r}
# calculate proportion of individuals that were found every year 
frog_line <- frogs_env %>% 
  
  # create 3 key size categories
  mutate(sul_mm = as.numeric(sul_mm)) %>% 
  mutate(size_group = case_when(sul_mm <= 54 ~ "small",
                                sul_mm > 54 & sul_mm < 66 ~ "medium",
                                sul_mm >= 66 ~ "large")) %>%
  
  # calculate annual proportion of surveyed/survived based on size
  group_by(year, size_group) %>% 
  summarise(count = sum(frog_detected)) %>% 
  
  # update yr column data type
  mutate(year = as.numeric(as.character(year)))

# plot yearly
frog_line %>% 
ggplot() +
  geom_vline(xintercept = 2014, linetype = 2) +
  geom_line(aes(x = year, y = count, col = size_group),
            linewidth = 1) +
  scale_color_manual(values = c('#f46036','#2e294e','#17c3b2')) +
  geom_point(aes(x = year, y = count, col = size_group)) + 
  theme_classic() +
  labs(col = "Relative Size", y = "No. Frogs Re-Captured", x = "Year",
       title = "Capture-Mark-Recapture Surveys (Jack Creek, Oregon)") +
    annotate("text", x = 2014,y = Inf, 
           label = "          drought mitigation\n(addition of excavated ponds)", size = 3,
    hjust = -0.1, vjust = 1.7) +
  scale_x_continuous(breaks = c(2009:2021, 3)) +
  theme(plot.title = element_text(size = 14))
```



```{r}
ndvi_line <- frogs_env %>% 
  
  # frog counts by sex
  group_by(year, sex) %>% 
  summarise(count = sum(frog_detected)) %>% 
  
  # join with precipitation data
  left_join(y = water, by = "year") %>% 
  
  # make year numeric
  mutate(year = as.numeric(as.character(year))) %>% 
  
  # remove 2009 because it doesn't have precipitation data
  filter(year != 2009)

ggplot(ndvi_line) +
  geom_line(aes(x = count, y = precip_accum, col = sex))

```

